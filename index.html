<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MathMagix â€” Finished</title>

  <!-- External libraries (CDNs) -->
  <!-- math.js for numeric eval -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.9.0/math.min.js" integrity="" crossorigin="anonymous"></script>

  <!-- nerdamer for symbolic diff/integral -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/nerdamer/1.1.14/nerdamer.core.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/nerdamer/1.1.14/Algebra.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/nerdamer/1.1.14/Calculus.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/nerdamer/1.1.14/Solve.min.js"></script>

  <!-- mathsteps for showing algebra steps -->
  <script src="https://unpkg.com/mathsteps@0.6.0/lib/browser/mathsteps.min.js"></script>

  <!-- Plotly for graphing -->
  <script src="https://cdn.plot.ly/plotly-2.25.2.min.js"></script>

  <!-- MathJax for nice math rendering -->
  <script>
    window.MathJax = {
      tex: {inlineMath: [['$', '$'], ['\\(', '\\)']]},
      svg: {fontCache: 'global'}
    };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>

  <style>
    /* IMPORTANT: I intentionally do NOT override your background.
       Do not add body { background: ... } here if you want to keep your existing background. */

    :root{
      --accent:#ff2d95;
      --panel-bg: rgba(0,0,0,0.55);
      --glass: rgba(255,255,255,0.03);
      --text: #ffffff;
      --muted: #cfcfcf;
      --radius:14px;
    }

    html,body{height:100%; margin:0; font-family: Inter, system-ui, Arial; color:var(--text);}
    /* page container */
    .app {
      min-height:100vh;
      display:flex;
      gap:24px;
      align-items:flex-start;
      padding:28px;
      box-sizing:border-box;
      backdrop-filter: blur(2px);
    }

    /* Sliding sidebar */
    .hamburger{
      position:fixed;
      left:18px;
      top:18px;
      z-index:999;
      width:48px;
      height:48px;
      display:flex;
      align-items:center;
      justify-content:center;
      background:var(--glass);
      border-radius:10px;
      cursor:pointer;
      box-shadow: 0 6px 18px rgba(0,0,0,0.4);
    }
    .hamburger span{
      width:26px; height:2px; background:var(--text); display:block; border-radius:2px; position:relative;
    }
    .hamburger span:before, .hamburger span:after{
      content:""; position:absolute; left:0; width:100%; height:100%; background:var(--text); border-radius:2px;
    }
    .hamburger span:before{ top:-8px }
    .hamburger span:after{ top:8px }

    .sidebar{
      position:fixed;
      left: -320px;
      top:0;
      bottom:0;
      width:320px;
      background: linear-gradient(180deg, rgba(0,0,0,0.65), rgba(0,0,0,0.5));
      padding:28px;
      transition: left .32s cubic-bezier(.2,.9,.3,1);
      z-index:998;
      box-shadow: 6px 0 30px rgba(0,0,0,0.5);
      overflow:auto;
    }
    .sidebar.open{ left:0; }

    .logo{
      font-family: 'Brush Script MT', cursive;
      font-size:28px;
      color:var(--accent);
      margin-bottom:10px;
    }
    .nav-item{ color:var(--muted); padding:10px 0; cursor:pointer;}
    .nav-item:hover{ color:#fff; }

    /* clear button pinned at top */
    .top-controls{
      position:fixed;
      right:18px;
      top:18px;
      display:flex;
      gap:10px;
      z-index:999;
    }
    .btn{
      background:var(--glass);
      border:1px solid rgba(255,255,255,0.06);
      color:var(--text);
      padding:10px 14px;
      border-radius:10px;
      cursor:pointer;
      font-weight:600;
      backdrop-filter: blur(4px);
      box-shadow: 0 6px 16px rgba(0,0,0,0.35);
    }

    /* main panel */
    .panel{
      flex:1;
      background: rgba(0,0,0,0.35);
      border-radius: var(--radius);
      padding:22px;
      min-width:360px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.55);
      margin-left:360px; /* leave space visually for sidebar even when closed */
    }

    .row{ display:flex; gap:14px; align-items:flex-start; }
    .col{ flex:1; min-width:0; }

    label{ display:block; font-size:13px; color:var(--muted); margin-bottom:6px; }
    input[type="text"], select, textarea{
      width:100%;
      padding:12px 12px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,0.06);
      background: rgba(255,255,255,0.02);
      color:var(--text);
      box-sizing:border-box;
      font-size:16px;
    }
    textarea{ min-height:120px; resize:vertical; }

    .controls { display:flex; gap:10px; margin-top:8px; align-items:center; flex-wrap:wrap; }
    .small{ padding:8px 10px; font-size:14px; border-radius:8px; }

    .result{
      margin-top:16px;
      background: rgba(0,0,0,0.42);
      padding:14px;
      border-radius:10px;
      min-height:48px;
    }
    .steps{
      margin-top:12px;
      background: rgba(255,255,255,0.03);
      border-radius:10px;
      padding:12px;
      max-height:320px;
      overflow:auto;
      font-size:14px;
      line-height:1.45;
      color:var(--muted);
    }

    .graph-box{
      margin-top:14px;
      background: rgba(0,0,0,0.42);
      padding:10px;
      border-radius:10px;
    }

    .footer-note{ font-size:12px; color:var(--muted); margin-top:10px; }

    /* responsive */
    @media (max-width:880px){
      .app{ padding:14px; }
      .panel{ margin-left:0; }
    }

  </style>
</head>
<body>
  <!-- Sliding hamburger and sidebar -->
  <div class="hamburger" id="hamb">
    <span></span>
  </div>

  <aside class="sidebar" id="sidebar">
    <div class="logo">MathMagix</div>
    <div class="nav-item" onclick="scrollToSection('main')">Home</div>
    <div class="nav-item" onclick="scrollToSection('calculator')">Calculator</div>
    <div class="nav-item" onclick="scrollToSection('calculus')">Differentiation / Integration</div>
    <div class="nav-item" onclick="scrollToSection('graph')">Graph Plotter</div>
    <div class="nav-item" onclick="scrollToSection('about')">About</div>
    <hr style="border:none;border-top:1px solid rgba(255,255,255,0.06); margin:14px 0;">
    <div style="color:var(--muted); font-size:13px">Tip: Auto-calc runs as you type. Use variable 'x' for graphs and calculus.</div>
  </aside>

  <div class="top-controls">
    <button class="btn" id="voiceBtn" title="Voice input (speak expression)">ðŸŽ™ Voice</button>
    <button class="btn" id="copyBtn" title="Copy result">Copy</button>
    <button class="btn" id="clearBtn" title="Clear everything">Clear</button>
  </div>

  <main class="app" id="main">
    <section class="panel" id="calculator">
      <h2 style="margin:0 0 6px 0">MathMagix â€” Calculator & Symbolic</h2>
      <div class="footer-note">Type expression below, select mode, and results will appear live (auto-calc).</div>

      <div style="height:10px"></div>

      <label for="expr">Expression</label>
      <input id="expr" type="text" placeholder="Examples: 2+3*4, sin(x)^2 + cos(x)^2, 3x^2+2x-5, integrate(sin(x),x)">

      <div class="controls" style="margin-top:8px;">
        <select id="mode" class="small">
          <option value="eval">Evaluate numerically</option>
          <option value="simplify">Simplify / Steps</option>
          <option value="differentiate">Differentiate (symbolic)</option>
          <option value="integrate">Integrate (symbolic)</option>
          <option value="solve">Solve (equation)</option>
        </select>

        <input id="varVal" type="text" class="small" placeholder="Set variable for eval: x=2 (optional)" style="min-width:190px;">
        <input id="variable" type="text" class="small" placeholder="Variable (default x)" style="width:110px;">

        <button id="runBtn" class="btn">Run</button>
      </div>

      <div class="result" id="resultArea" aria-live="polite">
        <div style="font-weight:700">Result:</div>
        <div id="resultRendered" style="margin-top:6px; font-size:16px;"></div>
      </div>

      <div class="steps" id="stepsArea" style="display:block;">
        <div style="font-weight:700; color:#fff">Steps / Work:</div>
        <div id="stepsContent" style="margin-top:8px;"></div>
      </div>

      <div class="graph-box" id="graphSection" style="display:block;">
        <div style="display:flex; gap:8px; align-items:center;">
          <label style="margin:0;">Graph range</label>
          <input id="xmin" class="small" placeholder="xmin" style="width:90px;">
          <input id="xmax" class="small" placeholder="xmax" style="width:90px;">
          <button id="plotBtn" class="btn">Plot</button>
        </div>
        <div id="plotlyDiv" style="height:360px; margin-top:10px;"></div>
      </div>

      <div class="footer-note" id="about" style="margin-top:12px">About: This page uses math.js (numeric), nerdamer (symbolic), mathsteps (algebra steps), and Plotly (graphs). Steps for complex symbolic transforms are best-effort for human-readable guidance.</div>
    </section>
  </main>

  <script>
    // DOM refs
    const sidebar = document.getElementById('sidebar');
    const hamb = document.getElementById('hamb');
    const exprInput = document.getElementById('expr');
    const runBtn = document.getElementById('runBtn');
    const modeSel = document.getElementById('mode');
    const resultRendered = document.getElementById('resultRendered');
    const stepsContent = document.getElementById('stepsContent');
    const clearBtn = document.getElementById('clearBtn');
    const copyBtn = document.getElementById('copyBtn');
    const voiceBtn = document.getElementById('voiceBtn');
    const varVal = document.getElementById('varVal');
    const variableInput = document.getElementById('variable');

    const plotBtn = document.getElementById('plotBtn');
    const plotlyDiv = document.getElementById('plotlyDiv');
    const xminInput = document.getElementById('xmin');
    const xmaxInput = document.getElementById('xmax');

    // Sidebar toggle
    hamb.addEventListener('click', ()=> sidebar.classList.toggle('open'));

    function scrollToSection(id){
      const el = document.getElementById(id);
      if(el) el.scrollIntoView({behavior:'smooth', block:'center'});
      sidebar.classList.remove('open');
    }

    // Utility: debounce
    function debounce(fn, ms=350){
      let t;
      return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); };
    }

    // Basic expression normalization for math.js and nerdamer
    function normalizeExpr(s){
      if(!s) return '';
      // replace ^ with ^ (nerdamer uses ^), math.js supports ^
      // ensure multiplication explicit: 3x -> 3*x
      // insert * between num and variable or paren: 3x -> 3*x, )( -> )*(
      s = s.replace(/(\d)([a-zA-Z\(])/g, '$1*$2');
      s = s.replace(/([a-zA-Z])(\d)/g, '$1*$2');
      s = s.replace(/([a-zA-Z])([a-zA-Z])/g, '$1*$2'); // xy -> x*y
      // tidy spaces
      return s;
    }

    // Show result helper (supports MathJax rendering)
    function showResult(text, raw=false){
      if(raw) resultRendered.textContent = text;
      else resultRendered.innerHTML = '$$' + escapeLatex(text) + '$$';
      if(window.MathJax && window.MathJax.typesetPromise) {
        window.MathJax.typesetPromise([resultRendered]).catch(()=>{});
      }
    }

    function escapeLatex(s){
      return s.replace(/\\/g,'\\').replace(/\$/g,'\\$');
    }

    // Attempt to produce algebra steps using mathsteps for simplification and solving
    function algebraSteps(input){
      try{
        const steps = mathsteps.simplifyExpression(input);
        if(!steps || steps.length===0) return null;
        const html = steps.map((st,i)=> `<div><b>Step ${i+1}:</b> ${st.changeType} â€” ${st.newNode.toString()}</div>`).join('');
        return html;
      }catch(e){
        return null;
      }
    }

    // Attempt to produce polynomial-like differentiation steps
    function polyDiffSteps(expr, v='x'){
      // This attempts to split sums and apply power rule for monomials.
      try{
        // Replace unary plus/minus issues
        let s = expr;
        // use nerdamer to expand for better splitting
        const expanded = nerdamer.expand(expr).toString();
        // split by + and - while keeping sign
        const terms = expanded.match(/[+\-]?[^+\-]+/g).map(t=>t.trim()).filter(Boolean);
        let steps = [];
        steps.push('Expand expression: ' + expanded);
        steps.push('Differentiate each term using power rule and basic rules (constant -> 0, c*x^n -> c*n*x^(n-1)).');
        const differentiatedTerms = terms.map(t=>{
          try{
            const d = nerdamer.diff(t, v).toString();
            return d;
          }catch(e){
            return '0'; // fallback
          }
        });
        steps.push('Term-by-term derivatives:');
        for(let i=0;i<terms.length;i++){
          steps.push(`${terms[i]}  â†’  ${differentiatedTerms[i]}`);
        }
        steps.push('Combine terms: ' + differentiatedTerms.join(' + '));
        return steps.join('<br>');
      }catch(e){
        return null;
      }
    }

    // Integration steps for simple polynomials
    function polyIntSteps(expr, v='x'){
      try{
        const expanded = nerdamer.expand(expr).toString();
        const terms = expanded.match(/[+\-]?[^+\-]+/g).map(t=>t.trim()).filter(Boolean);
        let steps = [];
        steps.push('Expand expression: ' + expanded);
        steps.push('Integrate term-by-term using power rule (âˆ« x^n dx = x^{n+1}/(n+1)) and constant multiple.');
        const integratedTerms = terms.map(t=>{
          try{
            const r = nerdamer.integrate(t, v).toString();
            return r;
          }catch(e){
            return '0';
          }
        });
        steps.push('Term-by-term integrals:');
        for(let i=0;i<terms.length;i++){
          steps.push(`${terms[i]}  â†’  ${integratedTerms[i]} + C`);
        }
        steps.push('Combine terms: ' + integratedTerms.join(' + ') + ' + C');
        return steps.join('<br>');
      }catch(e){
        return null;
      }
    }

    // Main compute function
    function compute(){
      const raw = exprInput.value.trim();
      if(!raw){
        showResult('â€”','raw');
        stepsContent.innerHTML = '';
        return;
      }
      const mode = modeSel.value;
      const variable = (variableInput.value || 'x').trim() || 'x';
      // parse varVal (e.g., x=2 or x=1,y=2)
      let scope = {};
      if(varVal.value.trim()){
        const parts = varVal.value.split(',').map(p=>p.trim());
        parts.forEach(p=>{
          const m = p.split('=');
          if(m.length===2){
            const name = m[0].trim();
            const val = Number(m[1].trim());
            if(!Number.isNaN(val)) scope[name]=val;
          }
        });
      }

      const expr = normalizeExpr(raw);

      // switch modes
      try{
        if(mode === 'eval'){
          // numeric evaluation: if variable provided in scope, substitute
          try{
            // For mathjs, replace '^' with '^' is fine
            const node = math.parse(expr);
            const compiled = node.compile();
            const res = compiled.evaluate(scope);
            showResult(String(res), true);
            stepsContent.innerHTML = `<div><b>Evaluation</b></div>
              <div>Parsed: <code>${escapeHtml(expr)}</code></div>
              <div>Scope: ${Object.keys(scope).length? JSON.stringify(scope): 'none'}</div>
              <div style="margin-top:8px"><b>Answer:</b> ${String(res)}</div>`;
          }catch(e){
            // fallback: try using nerdamer evaluation
            const val = nerdamer(expr).evaluate(scope).text();
            showResult(val, true);
            stepsContent.innerHTML = `<div>Answer (nerdamer): ${escapeHtml(val)}</div>`;
          }

        } else if(mode === 'simplify'){
          // try mathsteps for step breakdown
          const algebra = algebraSteps(expr);
          let out;
          if(algebra){
            out = `<div><b>Simplification steps (mathsteps):</b></div>${algebra}`;
            showResult(nerdamer(expr).toString(), true);
            stepsContent.innerHTML = out;
          }else{
            // fallback to nerdamer simplify
            const simp = nerdamer.simplify(expr).toString();
            showResult(simp, true);
            stepsContent.innerHTML = `<div>Could not provide step-by-step via mathsteps for this expression. Showing simplification:</div><div style="margin-top:8px">${escapeHtml(simp)}</div>`;
          }

        } else if(mode === 'differentiate'){
          // symbolic differentiation
          const derivative = nerdamer.diff(expr, variable).expand().toString();
          showResult(derivative, true);

          // attempt friendly steps
          let stepsHtml = polyDiffSteps(expr, variable);
          if(!stepsHtml){
            stepsHtml = `<div>Symbolic derivative computed: <code>${escapeHtml(derivative)}</code></div>
              <div>If step-by-step explanation is required, MathMagix attempts polynomial rules. For complex expressions, steps may be descriptive rather than fully formal.</div>`;
          }
          stepsContent.innerHTML = stepsHtml;

        } else if(mode === 'integrate'){
          const integral = nerdamer.integrate(expr, variable).expand().toString();
          showResult(integral + " + C", true);
          let stepsHtml = polyIntSteps(expr, variable);
          if(!stepsHtml){
            stepsHtml = `<div>Symbolic integral computed: <code>${escapeHtml(integral)}</code> + C</div>
                         <div>For complicated integrals, MathMagix provides the result. Step-by-step integration can be complex â€” try simpler polynomial/trigonometric inputs for clearer steps.</div>`;
          }
          stepsContent.innerHTML = stepsHtml;

        } else if(mode === 'solve'){
          // expect equation like "2x+3=7" or "x^2-4=0"
          if(!raw.includes('=')){
            stepsContent.innerHTML = `<div>Please provide an equation (e.g., x^2-4=0) to solve.</div>`;
            showResult('â€”','raw');
            return;
          }
          const sides = raw.split('=');
          const left = normalizeExpr(sides[0].trim());
          const right = normalizeExpr(sides.slice(1).join('=').trim());
          // nerdamer solve
          try{
            const eq = `${left}-${right}`;
            const sol = nerdamer.solveEquations(eq, variable);
            showResult(JSON.stringify(sol), true);
            // mathsteps solving for linear/quadratic steps?
            try{
              const ms = mathsteps.solveEquation(raw);
              if(ms && ms.length>0){
                const html = ms.map((st,i)=>`<div><b>Step ${i+1}:</b> ${st.changeType} â€” ${st.newEquation?st.newEquation.toString():''}</div>`).join('');
                stepsContent.innerHTML = `<div><b>Steps (mathsteps):</b></div>${html}`;
              } else {
                stepsContent.innerHTML = `<div>Solution: ${escapeHtml(JSON.stringify(sol))}</div>`;
              }
            }catch(e){
              stepsContent.innerHTML = `<div>Solution: ${escapeHtml(JSON.stringify(sol))}</div>`;
            }
          }catch(e){
            stepsContent.innerHTML = `<div>Error solving equation: ${escapeHtml(String(e))}</div>`;
            showResult('Error','raw');
          }
        }
      }catch(err){
        resultRendered.textContent = 'Error: ' + err.message;
        stepsContent.innerHTML = `<div style="color:#f88">Error: ${escapeHtml(err.message)}</div>`;
      }
    }

    // helper escape for plain HTML
    function escapeHtml(s){
      return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }

    // Debounced live auto-calc
    const liveCompute = debounce(()=> compute(), 450);
    exprInput.addEventListener('input', liveCompute);
    modeSel.addEventListener('change', compute);
    varVal.addEventListener('input', liveCompute);
    variableInput.addEventListener('input', liveCompute);

    // Run button explicit
    runBtn.addEventListener('click', compute);

    // Clear behavior (as requested to put Clear at top)
    clearBtn.addEventListener('click', ()=>{
      exprInput.value = '';
      resultRendered.textContent = '';
      stepsContent.innerHTML = '';
      plotlyDiv.innerHTML = '';
      xminInput.value = '';
      xmaxInput.value = '';
    });

    // Copy result
    copyBtn.addEventListener('click', ()=>{
      const txt = resultRendered.textContent || resultRendered.innerText || '';
      if(!txt) return alert('No result to copy');
      navigator.clipboard.writeText(txt).then(()=> alert('Result copied to clipboard') ).catch(()=> alert('Copy failed'));
    });

    // Voice input using Web Speech API (simple)
    let recognition;
    if('webkitSpeechRecognition' in window || 'SpeechRecognition' in window){
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      recognition.lang = 'en-IN';
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;
      recognition.onresult = (ev)=>{
        const spoken = ev.results[0][0].transcript;
        // minimal normalization: replace 'power' with '^', 'times' with '*', words to symbols common
        let normalized = spoken.replace(/power of/gi,'^').replace(/power/gi,'^').replace(/times/gi,'*').replace(/x equals/gi,'x=');
        // map some spoken words to symbols (very simple)
        normalized = normalized.replace(/plus/gi,'+').replace(/minus/gi,'-').replace(/divided by/gi,'/').replace(/over/gi,'/');
        exprInput.value = normalizeExpr(normalized);
        liveCompute();
      };
      recognition.onend = ()=> voiceBtn.classList.remove('active');
    } else {
      voiceBtn.disabled = true;
      voiceBtn.title = 'Voice input not supported in this browser';
    }

    voiceBtn.addEventListener('click', ()=>{
      if(!recognition) return alert('Voice input not supported here.');
      try{
        recognition.start();
        voiceBtn.classList.add('active');
      }catch(e){
        console.warn(e);
      }
    });

    // Plotting: uses Plotly to plot y = f(x)
    plotBtn.addEventListener('click', ()=>{
      const exprRaw = exprInput.value.trim();
      if(!exprRaw){ alert('Enter an expression in x to plot (e.g., sin(x)+x^2)'); return; }
      // convert to function using math.js compiled with x
      const expr = normalizeExpr(exprRaw);
      const xmin = Number(xminInput.value) || -10;
      const xmax = Number(xmaxInput.value) || 10;
      if(xmax <= xmin){ alert('xmax should be greater than xmin'); return; }
      const samples = 600;
      const xs = new Array(samples);
      const step = (xmax - xmin)/(samples-1);
      for(let i=0;i<samples;i++) xs[i] = xmin + i*step;
      let ys = [];
      try{
        const node = math.parse(expr);
        const compiled = node.compile();
        for(const x of xs){
          let val = compiled.evaluate({x});
          if(val && val.re !== undefined && val.im !== undefined) val = NaN; // complex -> NaN
          ys.push((typeof val === 'number' && isFinite(val))? val : NaN);
        }
        const trace = { x: xs, y: ys, mode: 'lines', name: exprRaw, line: {width:2} };
        const layout = { margin:{t:30,l:40,r:20,b:40}, paper_bgcolor:'rgba(0,0,0,0)', plot_bgcolor:'rgba(255,255,255,0.02)', xaxis:{title:'x'}, yaxis:{title:'y'} };
        Plotly.newPlot(plotlyDiv, [trace], layout, {responsive:true});
      }catch(e){
        alert('Plot error: ' + e.message);
      }
    });

    // small helper: initial demo text
    exprInput.value = '3*x^2 + 2*x - 5';
    variableInput.value = 'x';
    xminInput.value = '-10';
    xmaxInput.value = '10';
    compute(); // initial compute

    // small accessibility: press Enter runs compute too
    exprInput.addEventListener('keydown', (ev)=>{
      if(ev.key === 'Enter') compute();
    });

    // Show math steps for basic cases with mathsteps (if user chooses simplify or solve)
    // mathsteps usage already attempted in compute()

    // Final note: keep the page background as defined externally â€” this file avoids touching the body background.

  </script>

</body>
</html>
